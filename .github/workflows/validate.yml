name: Validate Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check manifest.json syntax
        run: |
          echo "Validating manifest.json..."
          cat extension/manifest.json | jq empty
          echo "✅ manifest.json is valid JSON"
      
      - name: Check required files exist
        run: |
          echo "Checking required files..."
          FILES=(
            "extension/manifest.json"
            "extension/background.js"
            "extension/content.js"
            "extension/download.js"
            "extension/popup.html"
            "extension/popup.js"
            "extension/lib/jszip.min.js"
          )
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            else
              echo "✅ $file exists"
            fi
          done
      
      - name: Check manifest version
        run: |
          VERSION=$(jq -r '.version' extension/manifest.json)
          echo "Extension version: $VERSION"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format. Must be X.Y.Z"
            exit 1
          fi
          echo "✅ Version format is valid"
      
      - name: Test build package
        run: |
          echo "Testing package creation..."
          cd extension
          zip -r ../test-package.zip . \
            -x "*.git*" \
            -x "test-*.html" \
            -x "README.md" \
            -x ".DS_Store"
          cd ..
          
          SIZE=$(stat -f%z test-package.zip 2>/dev/null || stat -c%s test-package.zip)
          echo "Package size: $SIZE bytes"
          
          if [ $SIZE -lt 10000 ]; then
            echo "❌ Package seems too small"
            exit 1
          fi
          
          echo "✅ Package created successfully"
          
          # List contents
          unzip -l test-package.zip | head -20
      
      - name: Summary
        run: |
          echo "### ✅ Extension Validation Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks completed successfully." >> $GITHUB_STEP_SUMMARY
